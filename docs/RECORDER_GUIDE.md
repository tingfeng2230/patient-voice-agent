# 患者信息录音采集功能使用指南

## 功能概述

本系统提供了一个完整的语音录音功能，用户可以通过浏览器点击按钮进行录音，系统会自动：

1. 🎤 **实时录音**：在浏览器中录制患者问诊语音
2. 📝 **语音识别**：将录音转换为文本
3. 📊 **信息提取**：自动提取患者姓名和问诊记录
4. 📋 **表单生成**：生成结构化的就诊信息表单

## 使用步骤

### 1. 启动服务

在项目根目录下执行：

```bash
python -m src.main -m http -p 5000
```

服务将在 `http://localhost:5000` 启动。

### 2. 访问录音页面

在浏览器中打开：

```
http://localhost:5000/static/recorder.html
```

### 3. 开始录音

1. 点击页面中央的红色麦克风按钮开始录音
2. 录音时按钮会显示脉冲动画，计时器开始计时
3. 再次点击按钮停止录音

### 4. 预览和提交

录音完成后：
- 可以播放预览录音内容
- 点击"提交处理"按钮发送录音
- 点击"重新录音"按钮重新录制

### 5. 查看结果

系统会自动处理录音并展示：
- **姓名**：患者姓名（从语音中提取）
- **问诊记录**：完整的问诊内容（原始语音转文本）

## 技术架构

### 前端（assets/recorder.html）

- 使用 Web Audio API 实现录音功能
- 使用 MediaRecorder API 捕获音频流
- 将音频转换为 Base64 格式上传

### 后端（src/main.py）

- 提供静态文件服务（/static路由）
- 提供 API 接口（/api/process-audio）
- 集成对象存储服务，保存音频文件
- 调用 Agent 进行语音识别和信息提取

### Agent（src/agents/agent.py）

- 集成语音识别工具（voice_recognition）
- 智能提取患者信息
- 生成结构化表单

## API 接口

### POST /api/process-audio

处理录音上传并返回患者信息表单。

**请求体：**
```json
{
  "audio_base64": "UklGRiQAAABXQVZFZm10IBIA...",
  "format": "webm"
}
```

**响应：**
```json
{
  "status": "success",
  "result": "## 就诊患者信息表单\n\n| 字段 | 内容 |\n|------|------|\n| 姓名 | 张三 |\n| 问诊记录 | 患者说，我最近感觉头晕，已经持续三天了... |",
  "run_id": "xxx-xxx-xxx"
}
```

## 支持的音频格式

- **格式**：WebM（默认）、MP3、WAV、OGG OPUS
- **时长**：≤ 2小时
- **大小**：≤ 100MB

## 注意事项

1. **浏览器权限**：首次使用需要授权麦克风权限
2. **网络要求**：录音上传需要稳定的网络连接
3. **音频质量**：建议在安静环境下录音，以获得更好的识别效果
4. **录音内容**：录音应包含患者的姓名和详细的问诊描述

## 故障排除

### 问题：无法访问麦克风

**解决方案**：
- 检查浏览器是否已授权麦克风权限
- 确保设备有可用的麦克风
- 尝试使用 Chrome、Firefox 等现代浏览器

### 问题：录音上传失败

**解决方案**：
- 检查网络连接是否正常
- 确认后端服务是否正常运行
- 查看浏览器控制台是否有错误信息

### 问题：语音识别失败

**解决方案**：
- 确保录音清晰，无杂音
- 检查音频格式是否支持
- 查看后端日志获取详细错误信息

## 示例录音内容

为了获得最佳识别效果，录音可以包含以下内容：

```
"你好，我是张三。我今天来医院是因为最近三天一直感觉头晕，尤其是在早上起床的时候比较明显。以前没有类似的症状，也没有高血压病史。希望能检查一下是什么原因。"
```

系统会自动提取：
- **姓名**：张三
- **问诊记录**：我今天来医院是因为最近三天一直感觉头晕，尤其是在早上起床的时候比较明显。以前没有类似的症状，也没有高血压病史。希望能检查一下是什么原因。

## 开发和扩展

如需自定义表单字段，修改以下文件：

1. **System Prompt**：`config/agent_llm_config.json` 中的 `sp` 字段
2. **Agent 逻辑**：`src/agents/agent.py`

如需修改前端界面，编辑：
- **前端页面**：`assets/recorder.html`

如需添加新的功能接口，修改：
- **后端路由**：`src/main.py`
