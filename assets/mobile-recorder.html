<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ‰‹æœºç«¯è¯­éŸ³å½•å…¥</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 25px;
            max-width: 600px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            font-size: 22px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 13px;
        }

        .session-info {
            background: #f0f7ff;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .session-info .label {
            color: #667eea;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .session-info .code {
            font-size: 28px;
            font-weight: bold;
            color: #333;
            letter-spacing: 3px;
            font-family: 'Courier New', monospace;
        }

        .session-info .hint {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
        }

        .copy-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .copy-btn:hover {
            background: #5568d3;
        }

        .copy-btn:active {
            transform: scale(0.95);
        }

        .recorder-section {
            text-align: center;
            margin-bottom: 20px;
        }

        .record-btn {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(238, 90, 111, 0.4);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }

        .record-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 30px rgba(238, 90, 111, 0.5);
        }

        .record-btn.recording {
            background: linear-gradient(135deg, #ff4757 0%, #ff3838 100%);
            animation: pulse 1.5s ease-in-out infinite;
        }

        .record-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 8px 20px rgba(238, 90, 111, 0.4);
            }
            50% {
                box-shadow: 0 8px 40px rgba(238, 90, 111, 0.8);
            }
        }

        .record-btn svg {
            width: 35px;
            height: 35px;
            margin-bottom: 6px;
        }

        .status {
            margin-top: 15px;
            font-size: 14px;
            color: #666;
            min-height: 20px;
        }

        .status.connected {
            color: #2ecc71;
        }

        .status.disconnected {
            color: #e74c3c;
        }

        .live-text {
            margin-top: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            text-align: left;
            min-height: 60px;
            font-size: 14px;
            color: #555;
            line-height: 1.6;
        }

        .live-text .interim {
            color: #999;
            font-style: italic;
        }

        .live-text .final {
            color: #333;
        }

        .connection-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .connection-status .label {
            font-size: 13px;
            color: #666;
        }

        .connection-status .indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ccc;
            transition: all 0.3s;
        }

        .connection-status .indicator.connected {
            background: #2ecc71;
            box-shadow: 0 0 10px #2ecc71;
        }

        .connection-status .indicator.disconnected {
            background: #e74c3c;
        }

        .browser-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 13px;
            display: none;
        }

        .browser-warning.show {
            display: block;
        }

        .preview-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .preview-card .title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .preview-card .field {
            margin-bottom: 10px;
        }

        .preview-card .field-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .preview-card .field-value {
            font-size: 14px;
            color: #333;
            padding: 8px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            min-height: 40px;
            word-break: break-word;
        }

        .preview-card .field-value.empty {
            color: #999;
            font-style: italic;
        }

        .instructions {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 12px;
            margin-top: 15px;
            font-size: 12px;
            color: #1976d2;
        }

        .instructions h3 {
            margin-bottom: 8px;
            font-size: 13px;
        }

        .instructions ol {
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“± æ‰‹æœºç«¯è¯­éŸ³å½•å…¥</h1>
        <p class="subtitle">å½•éŸ³å†…å®¹å°†å®æ—¶åŒæ­¥åˆ°ç”µè„‘ç«¯è¡¨å•</p>
        
        <div class="browser-warning" id="browserWarning">
            âš ï¸ æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå®æ—¶è¯­éŸ³è¯†åˆ«åŠŸèƒ½ã€‚å»ºè®®ä½¿ç”¨ Chromeã€Edge æˆ– Safari æµè§ˆå™¨ã€‚
        </div>
        
        <div class="connection-status">
            <span class="label">è¿æ¥çŠ¶æ€</span>
            <div class="indicator" id="connectionIndicator"></div>
        </div>

        <div class="session-info">
            <div class="label">ä¼šè¯ç ï¼ˆåœ¨ç”µè„‘ç«¯è¾“å…¥ï¼‰</div>
            <div class="code" id="sessionCode">ç”Ÿæˆä¸­...</div>
            <button class="copy-btn" id="copyBtn">å¤åˆ¶ä¼šè¯ç </button>
            <p class="hint">ç”µè„‘ç«¯è®¿é—® /static/desktop-form.html è¾“å…¥æ­¤ä¼šè¯ç </p>
        </div>

        <div class="recorder-section">
            <button id="recordBtn" class="record-btn" disabled>
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5z"/>
                    <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                </svg>
                <span id="recordBtnText">è¿æ¥ä¸­...</span>
            </button>
            
            <div class="status" id="status">æ­£åœ¨è¿æ¥åˆ°æœåŠ¡å™¨...</div>
            
            <div class="live-text" id="liveText">
                <span class="interim">ç­‰å¾…è¿æ¥...</span>
            </div>
        </div>

        <div class="preview-card">
            <div class="title">ğŸ“‹ å®æ—¶é¢„è§ˆ</div>
            <div class="field">
                <div class="field-label">æ‚£è€…å§“å</div>
                <div class="field-value empty" id="previewName">ç­‰å¾…è¯†åˆ«...</div>
            </div>
            <div class="field">
                <div class="field-label">é—®è¯Šè®°å½•</div>
                <div class="field-value empty" id="previewRecord">ç­‰å¾…è¯†åˆ«...</div>
            </div>
        </div>

        <div class="instructions">
            <h3>ğŸ“– ä½¿ç”¨è¯´æ˜</h3>
            <ol>
                <li>å°†ä¸Šæ–¹ä¼šè¯ç å‘é€ç»™ç”µè„‘ç«¯</li>
                <li>ç”µè„‘ç«¯è®¿é—®é¡µé¢å¹¶è¾“å…¥ä¼šè¯ç </li>
                <li>ç‚¹å‡»çº¢è‰²æŒ‰é’®å¼€å§‹å½•éŸ³</li>
                <li>è¯´è¯æ—¶å†…å®¹ä¼šå®æ—¶åŒæ­¥åˆ°ç”µè„‘ç«¯</li>
            </ol>
        </div>
    </div>

    <script>
        // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        if (!SpeechRecognition) {
            document.getElementById('browserWarning').classList.add('show');
            document.getElementById('recordBtn').disabled = true;
            document.getElementById('recordBtnText').textContent = 'ä¸æ”¯æŒ';
        }

        // ç”Ÿæˆä¼šè¯ ID
        function generateSessionId() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        let sessionId = generateSessionId();
        let recognition;
        let isRecording = false;
        let finalTranscript = '';
        let lastRecognizedText = '';
        let ws = null;
        let currentData = {
            patient_name: '',
            medical_record: ''
        };

        const sessionCode = document.getElementById('sessionCode');
        const copyBtn = document.getElementById('copyBtn');
        const connectionIndicator = document.getElementById('connectionIndicator');
        const recordBtn = document.getElementById('recordBtn');
        const recordBtnText = document.getElementById('recordBtnText');
        const status = document.getElementById('status');
        const liveText = document.getElementById('liveText');
        const previewName = document.getElementById('previewName');
        const previewRecord = document.getElementById('previewRecord');

        // æ˜¾ç¤ºä¼šè¯ç 
        sessionCode.textContent = sessionId;

        // å¤åˆ¶ä¼šè¯ç 
        copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(sessionId).then(() => {
                copyBtn.textContent = 'å·²å¤åˆ¶ï¼';
                setTimeout(() => {
                    copyBtn.textContent = 'å¤åˆ¶ä¼šè¯ç ';
                }, 2000);
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
            });
        });

        // å»ºç«‹ WebSocket è¿æ¥
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            ws = new WebSocket(`${protocol}//${host}/ws/${sessionId}`);

            ws.onopen = () => {
                connectionIndicator.classList.add('connected');
                connectionIndicator.classList.remove('disconnected');
                status.textContent = 'âœ… å·²è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œç‚¹å‡»å¼€å§‹å½•éŸ³';
                status.classList.add('connected');
                recordBtn.disabled = false;
                recordBtnText.textContent = 'å¼€å§‹å½•éŸ³';
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                console.log('æ”¶åˆ°æ¶ˆæ¯:', message);

                if (message.type === 'init' || message.type === 'update') {
                    currentData = message.data;
                    updatePreview();
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                status.textContent = 'âŒ è¿æ¥é”™è¯¯';
                status.classList.add('disconnected');
            };

            ws.onclose = () => {
                connectionIndicator.classList.remove('connected');
                connectionIndicator.classList.add('disconnected');
                status.textContent = 'âŒ è¿æ¥å·²æ–­å¼€ï¼Œæ­£åœ¨é‡è¿...';
                status.classList.add('disconnected');
                recordBtn.disabled = true;
                recordBtnText.textContent = 'è¿æ¥ä¸­...';
                
                // 5ç§’åå°è¯•é‡è¿
                setTimeout(connectWebSocket, 5000);
            };
        }

        // æ›´æ–°é¢„è§ˆæ˜¾ç¤º
        function updatePreview() {
            if (currentData.patient_name) {
                previewName.textContent = currentData.patient_name;
                previewName.classList.remove('empty');
            } else {
                previewName.textContent = 'ç­‰å¾…è¯†åˆ«...';
                previewName.classList.add('empty');
            }

            if (currentData.medical_record) {
                previewRecord.textContent = currentData.medical_record;
                previewRecord.classList.remove('empty');
            } else {
                previewRecord.textContent = 'ç­‰å¾…è¯†åˆ«...';
                previewRecord.classList.add('empty');
            }
        }

        // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«
        function initRecognition() {
            if (!SpeechRecognition) return;

            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                isRecording = true;
                recordBtn.classList.add('recording');
                recordBtnText.textContent = 'åœæ­¢å½•éŸ³';
                status.textContent = 'ğŸ¤ æ­£åœ¨å½•éŸ³ï¼Œè¯·è¯´è¯...';
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let newText = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;

                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                        newText = transcript;
                        
                        // æ›´æ–°é—®è¯Šè®°å½•
                        const currentRecord = currentData.medical_record || '';
                        if (currentRecord && !currentRecord.endsWith('ã€‚') && !currentRecord.endsWith('ï¼') && !currentRecord.endsWith('ï¼Ÿ')) {
                            currentData.medical_record = currentRecord + transcript;
                        } else {
                            currentData.medical_record = currentRecord + ' ' + transcript;
                        }
                        
                        // æå–å§“å
                        extractNameFromText(transcript);
                        
                        // å‘é€åˆ°æœåŠ¡å™¨
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            ws.send(JSON.stringify({
                                type: 'update',
                                data: currentData
                            }));
                        }
                        
                        updatePreview();
                        lastRecognizedText = transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                // æ˜¾ç¤ºå®æ—¶è¯†åˆ«æ–‡æœ¬
                if (interimTranscript || lastRecognizedText) {
                    const displayText = interimTranscript || lastRecognizedText;
                    liveText.innerHTML = `<span class="final">${finalTranscript}</span>`;
                    if (interimTranscript) {
                        liveText.innerHTML += `<span class="interim"> ${interimTranscript}</span>`;
                    }
                }
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                let errorMsgText = '';
                
                switch (event.error) {
                    case 'no-speech':
                        errorMsgText = 'æ²¡æœ‰æ£€æµ‹åˆ°è¯­éŸ³';
                        break;
                    case 'audio-capture':
                        errorMsgText = 'æ— æ³•è®¿é—®éº¦å…‹é£';
                        break;
                    case 'not-allowed':
                        errorMsgText = 'éº¦å…‹é£æƒé™è¢«æ‹’ç»';
                        break;
                    default:
                        errorMsgText = `è¯†åˆ«é”™è¯¯: ${event.error}`;
                }
                
                status.textContent = 'âŒ ' + errorMsgText;
            };

            recognition.onend = () => {
                if (isRecording) {
                    try {
                        recognition.start();
                    } catch (e) {
                        console.error('Failed to restart recognition:', e);
                        stopRecording();
                    }
                }
            };
        }

        // ä»æ–‡æœ¬ä¸­æå–å§“å
        function extractNameFromText(text) {
            const patterns = [
                /æˆ‘æ˜¯\s*([^\s,ï¼Œã€‚ï¼ï¼Ÿ]{2,4})/g,
                /æˆ‘å«\s*([^\s,ï¼Œã€‚ï¼ï¼Ÿ]{2,4})/g,
                /æ‚£è€…\s*([^\s,ï¼Œã€‚ï¼ï¼Ÿ]{2,4})/g,
                /å§“å[:ï¼š]\s*([^\s,ï¼Œã€‚ï¼ï¼Ÿ]{2,4})/g,
            ];

            for (const pattern of patterns) {
                const match = pattern.exec(text);
                if (match && match[1]) {
                    const name = match[1].trim();
                    if (/^[\u4e00-\u9fa5]{2,4}$/.test(name)) {
                        if (!currentData.patient_name || text.includes('æˆ‘å«') || text.includes('æˆ‘æ˜¯')) {
                            currentData.patient_name = name;
                        }
                        break;
                    }
                }
            }
        }

        // å¼€å§‹å½•éŸ³
        function startRecording() {
            if (!SpeechRecognition || !ws || ws.readyState !== WebSocket.OPEN) return;
            
            try {
                recognition.start();
            } catch (error) {
                console.error('Failed to start recognition:', error);
            }
        }

        // åœæ­¢å½•éŸ³
        function stopRecording() {
            if (!SpeechRecognition) return;
            
            isRecording = false;
            recordBtn.classList.remove('recording');
            recordBtnText.textContent = 'ç»§ç»­å½•éŸ³';
            status.textContent = 'â¸ï¸ å½•éŸ³å·²æš‚åœ';
            
            if (recognition) {
                recognition.stop();
            }
        }

        // äº‹ä»¶ç›‘å¬
        recordBtn.addEventListener('click', () => {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        });

        // åˆå§‹åŒ–
        connectWebSocket();
        initRecognition();
    </script>
</body>
</html>
